on:
 workflow_call:
  inputs:
   runFlow:
    required: true
    type: boolean
   envVariable:
    required: true
    type: string

jobs:
 # ğŸ” Security Scan (Gitleaks + Trivy)
 security-scan:
  name: ğŸ” Security Scan
  runs-on: ubuntu-latest
  env:
   GITHUB_TOKEN: ${{ secrets.PAT }}
  steps:
   - name: Check out code
     uses: actions/checkout@v4
     with:
      ref: master

   # -------------------------------
   # ğŸ“¦ Cache Trivy database
   # -------------------------------
   - name: Cache Trivy database (week ${{ env.CACHE_WEEK }})
     uses: actions/cache@v4
     with:
      path: |
       ~/.cache/trivy
       /root/.cache/trivy
      key: ${{ runner.os }}-trivy-db-${{ env.CACHE_WEEK }}
      restore-keys: |
       ${{ runner.os }}-trivy-db-

   # -------------------------------
   # ğŸ” Security scans con Trivy
   # -------------------------------
   - name: Run security scan CODE
     uses: aquasecurity/trivy-action@master
     with:
      args: "--skip-dev"
      scan-type: fs
      hide-progress: true
      scan-ref: "."
      severity: MEDIUM,HIGH,CRITICAL
      output: trivyCode.txt
      exit-code: ${{ github.event.inputs.envVariable == 'prod' && '1' || '0' }}

   - name: Run security scan CONFIG
     uses: aquasecurity/trivy-action@master
     with:
      scan-type: config
      hide-progress: true
      scan-ref: "."
      severity: MEDIUM,HIGH,CRITICAL
      output: trivyConfig.txt
      exit-code: ${{ github.event.inputs.envVariable == 'prod' && '1' || '0' }}
      skip-setup-trivy: true
      args: "--skip-dev"

   # -------------------------------
   # ğŸ’¾ Upload artifacts
   # -------------------------------
   - name: Upload security scan results
     uses: actions/upload-artifact@v4
     if: always()
     with:
      name: security-results
      path: |
       trivyCode.txt
       trivyConfig.txt

 # ğŸ§¹ Lint
 lint:
  name: ğŸ§¹ Lint
  runs-on: ubuntu-latest
  env:
   GITHUB_TOKEN: ${{ secrets.PAT }}
  steps:
   - name: Check out code
     uses: actions/checkout@v4
     with:
      ref: master

   - uses: actions/setup-node@v4
     with:
      node-version: "20"

   # -------------------------------
   # ğŸ“¦ Cache
   # -------------------------------
   - name: Cache node modules (solo per questa esecuzione)
     uses: actions/cache@v4
     with:
      path: |
       **/node_modules
       ~/.cache/yarn
      key: temp-yarn-cache-${{ github.run_id }}
      restore-keys: |
       temp-yarn-cache-${{ github.run_id }}

   - name: Install node dependencies
     run: yarn install

   - name: Lint
     run: yarn lint

 # ğŸ§ª Test & Coverage
 test:
  name: ğŸ§ª Test & Coverage
  runs-on: ubuntu-latest
  env:
   GITHUB_TOKEN: ${{ secrets.PAT }}
  steps:
   - name: Check out code
     uses: actions/checkout@v4
     with:
      ref: master

   - uses: actions/setup-node@v4
     with:
      node-version: "20"

   # -------------------------------
   # ğŸ“¦ Cache
   # -------------------------------
   - name: Cache node modules (solo per questa esecuzione)
     uses: actions/cache@v4
     with:
      path: |
       **/node_modules
       ~/.cache/yarn
      key: temp-yarn-cache-${{ github.run_id }}
      restore-keys: |
       temp-yarn-cache-${{ github.run_id }}

   - name: Install node dependencies
     run: yarn install

   - name: Unit test
     run: yarn test

   # -------------------------------
   # ğŸ“Š Coverage
   # -------------------------------
   - name: Unit test & coverage
     run: yarn test:coverage-summary

   - name: Jest Coverage Comment
     uses: MishaKav/jest-coverage-comment@main
     with:
      coverage-summary-path: ./reports-jest/coverage-summary.json
      coverage-title: Coverage details
      coverage-path: ./reports-jest/coverage.txt
      title: Coverage JEST
      summary-title: Coverage code
      badge-title: Coverage
      hide-comment: false
      create-new-comment: false
      hide-summary: false

   # -------------------------------
   # ğŸ’¾ Upload artifacts
   # -------------------------------
   - name: Upload coverage results
     uses: actions/upload-artifact@v4
     if: always()
     with:
      name: coverage-results
      path: |
       ./reports-jest/coverage.txt
       ./reports-jest/coverage-summary.json

 # ğŸ“ QA Summary
 qa-summary:
  name: ğŸ“ QA Summary
  runs-on: ubuntu-latest
  needs: [security-scan, lint, test]
  if: always()
  steps:
   # -------------------------------
   # ğŸ“¥ Download artifacts
   # -------------------------------
   - name: Download security results
     uses: actions/download-artifact@v4
     continue-on-error: true
     with:
      name: security-results
      path: ./security-results

   - name: Download coverage results
     uses: actions/download-artifact@v4
     continue-on-error: true
     with:
      name: coverage-results
      path: ./coverage-results

   # -------------------------------
   # ğŸ“‹ Prepara contenuto del commento
   # -------------------------------
   - name: Prepare PR comment content
     id: prepare-comment
     run: |
      COMMENT="### ğŸ§ª QA Summary (week ${{ env.CACHE_WEEK }})\n\n"
      COMMENT+="**Job Results:**\n"
      COMMENT+="- ğŸ” Security Scan: ${{ needs.security-scan.result }}\n"
      COMMENT+="- ğŸ§¹ Lint: ${{ needs.lint.result }}\n"
      COMMENT+="- ğŸ§ª Test: ${{ needs.test.result }}\n\n"

      if [[ -f ./coverage-results/coverage.txt ]]; then
        COMMENT+="#### ğŸ§© Coverage Output\n\`\`\`terraform\n$(cat ./coverage-results/coverage.txt)\n\`\`\`\n\n"
      fi

      if [[ -f ./security-results/trivyConfig.txt ]]; then
        COMMENT+="#### ğŸ” Security Scan CONFIG\n\`\`\`terraform\n$(cat ./security-results/trivyConfig.txt)\n\`\`\`\n\n"
      fi

      if [[ -f ./security-results/trivyCode.txt ]]; then
        COMMENT+="#### ğŸ§± Security Scan CODE\n\`\`\`terraform\n$(cat ./security-results/trivyCode.txt)\n\`\`\`\n\n"
      fi

      echo "comment<<EOF" >> $GITHUB_OUTPUT
      echo -e "$COMMENT" >> $GITHUB_OUTPUT
      echo "EOF" >> $GITHUB_OUTPUT

   # -------------------------------
   # ğŸ’¬ Pubblica commento nel PR
   # -------------------------------
   - name: Comment on PR
     uses: peter-evans/create-or-update-comment@v4
     with:
      token: ${{ secrets.GITHUB_TOKEN }}
      issue-number: ${{ github.event.pull_request.number }}
      body: ${{ steps.prepare-comment.outputs.comment }}
      edit-mode: replace
